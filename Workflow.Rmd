---
title: "Chemotion-Viz"
author: "Florian Schmidt"
output:
  html_document:
    df_print: paged
---
```{r include=FALSE}
knitr::read_chunk('Knitr_Workflow.R')
```

Aufgabe ist es aus der Chemotion Repository (https://www.chemotion-repository.net/welcome) alle bisher hinterlegten Substanzen zu klassifizieren und eine deskriptive Statistik des erhaltenen Datensatzes anzufertigen. Hierzu wird im Folgendem das verwendete R-Script beschrieben.

Im ersten Schritt werden die benötigten Pakete geladen:
```{r packages, message=FALSE}
```

Die benötigten canonical smiles der Substanzen aus der Chemotion Repository können als XLSX-Datei heruntergeladen werden. Hierfür muss ein Account auf der Homepage der Chemotion Repository angelegt werden. Unter dem Reiter "My DB" können unter "Chemotion" alle bisher eingetragenen Substanzen markiert und dann als XLSX-Datei exportiert werden. 
In der heruntergeladenen XLSX-Datei befinden sich anschließend noch Duplikate, sowie Lösungsmittel (solvents) und Reaktionspartner (reactants). Nach Entfernung dieser Substanzen wird die XLSX-Datei in eine CSV-Datei konvertiert und kann dann in R eingelesen werden.
```{r smiles}
```

Mit dem Paket "rinchi" (https://rdrr.io/github/CDK-R/rinchi/man/getinchi.html#heading-0) werden nun die canonical smiles in InChikeys konvertiert, damit diese zur Klassifizierung notwenig sind.
```{r smiles_to_InChiKey}
```

Im nächsten Schritt werden die InChiKeys verwendet, um eine Klassifizierung der Substanzen durchzuführen. Die Klassifizierung erfolgt mit dem Paket "classyfireR" (https://github.com/aberHRML/classyfireR). Die Funktion "get_classification" erzeugt eine Klassifizierungsliste. In dieser wird für jede Substanz ein Objekt welches Listen mit Tibbles enthält angelegt. Aus diesem Objekt können dann zum Beispiel Metadaten und die Klassifizierungstabelle ausgelesen werden (siehe folgende Ausgabe, Objekt 1). Für Substanzen die nicht klassifiziert werden konnten wird ein Objekt vom Typ "NULL" erzeugt (siehe folgende Ausgabe, Objekt 2+3).
```{r classification, message=FALSE}
```

Nun kann der gewünschte Klassifizierungsgrad der Substanzen ausgewählt werden, hier level="class" ("kingdom"=1; "superclass"=2; "class"=3; "subclass"=4).
```{r level}
```

Zum Auslesen des Klassifizierungsgrades wird eine For-Schleife genutzt. Für diese wird zunächst ein leerer Vektor mit der Länge der erzeugten Klassifizierungsliste erzeugt. Die For-Schleife iteriert über die einzelnen Objekte der Klassifizierungsliste, um den gewünschten Klassifizierungsgrad auszulesen. Mit einer If-Bedingung werden Objekte abgefangen, die vom Typ "NULL" sind. Die Schleife füllt den zuvor erzeugten leeren Vektor mit den Klassifizierungsgrad der jeweiligen Substanz.
```{r loop}
```

Anzahl der zu klassifizierenden Substanzen aus der Chemotion Repository (Größe des Datensatzes):
```{r n_substances, echo=FALSE}
```

Im nächsten Schritt werden die leeren Strings aus dem class-Vektor in "NA" überführt und dann entfernt.
```{r null, results='hide'}
```

Anschließend wird der Klassifizierungsgrad der Substanzen alphabetisch sortiert, in einen Data Frame geschrieben und ausgezählt. Die Ausgabe ist dann ein Data Frame mit den alphabetisch sortierten Substanzklassen und der Anzahl dieser im Datensatz.
```{r sort}
```

Anzahl der erfolgreich klassifizierten Substanzen aus der Chemotion Repository:
```{r n_substances_class, echo=FALSE}
```

Mithilfe dieses Data Frames kann die Darstellung des Klassifizierungslevel "class" aller klassifizierten Substanzen prozentual als Sunburst-Plot erfolgen. Die Erstellung des Sunburst Plots erfolgte mit dem Paket "sunburstR" (https://github.com/timelyportfolio/sunburstR)
```{r plot}
```

Neben der Darstellung der prozentualen Anteile der Substanzklassen können mithilfe des Paketes "RMassBank" (https://bioconductor.org/packages/release/bioc/html/RMassBank.html) die molaren Massen der Substanzen aus den canonical smiles berechnet werden. Der erstellte Data Frame zeigt die ersten drei Substanzen aus dem Datensatz mit der jeweiligen molaren Masse [g/mol] an.
```{r smiles2mass}
```
